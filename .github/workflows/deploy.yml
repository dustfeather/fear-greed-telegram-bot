name: Deploy to Cloudflare Workers
permissions:
  contents: read

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Cloudflare Workers
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Required Secrets
        shell: bash
        run: |
          set -euo pipefail
          
          # Check required secrets exist
          REQUIRED_SECRETS=(
            "TELEGRAM_BOT_TOKEN_SECRET"
            "ADMIN_CHAT_ID"
            "FEAR_GREED_KV_NAMESPACE_ID"
            "CF_API_TOKEN"
            "CF_ACCOUNT_ID"
          )
          
          MISSING_SECRETS=()
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${!secret:-}" ]; then
              MISSING_SECRETS+=("$secret")
            fi
          done
          
          if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo "❌ Error: Missing required secrets:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            exit 1
          fi
          
          echo "✓ All required secrets are present"
        env:
          TELEGRAM_BOT_TOKEN_SECRET: ${{ secrets.TELEGRAM_BOT_TOKEN_SECRET }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          FEAR_GREED_KV_NAMESPACE_ID: ${{ secrets.FEAR_GREED_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Generate wrangler.jsonc Configuration
        shell: bash
        env:
          FEAR_GREED_KV_NAMESPACE_ID: ${{ secrets.FEAR_GREED_KV_NAMESPACE_ID }}
          FEAR_GREED_KV_PREVIEW_ID: ${{ secrets.FEAR_GREED_KV_PREVIEW_ID }}
        run: |
          set -euo pipefail
          
          # Generate wrangler.jsonc from environment variables using Node.js script
          node scripts/generate-wrangler-config.js
          
          # Verify the file was created and is not empty
          if [ ! -f wrangler.jsonc ] || [ ! -s wrangler.jsonc ]; then
            echo "❌ Error: wrangler.jsonc was not created or is empty"
            exit 1
          fi
          
          # Validate JSONC syntax
          if ! node -e "require('fs').readFileSync('wrangler.jsonc', 'utf8'); JSON.parse(require('fs').readFileSync('wrangler.jsonc', 'utf8').replace(/\/\/.*/g, ''));" > /dev/null 2>&1; then
            echo "❌ Error: wrangler.jsonc contains invalid JSON syntax"
            exit 1
          fi
          
          echo "Configuration preview (values redacted):"
          sed 's/"id":\s*"[^"]*"/"id": "***REDACTED***"/' wrangler.jsonc | sed 's/"preview_id":\s*"[^"]*"/"preview_id": "***REDACTED***"/' || true

      - name: Install Dependencies
        run: npm ci

      - name: Run TypeScript Type Check
        run: npm run type-check

      - name: Validate wrangler.jsonc Configuration
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          workingDirectory: .
          command: deploy --dry-run
        continue-on-error: false

      - name: Set Cloudflare Secrets
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN_SECRET: ${{ secrets.TELEGRAM_BOT_TOKEN_SECRET }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          set -euo pipefail
          
          # Validate required secrets are not empty
          if [ -z "${TELEGRAM_BOT_TOKEN_SECRET:-}" ] || [ -z "${ADMIN_CHAT_ID:-}" ]; then
            echo "❌ Error: TELEGRAM_BOT_TOKEN_SECRET or ADMIN_CHAT_ID is empty"
            exit 1
          fi
          
          # Validate wrangler.jsonc exists
          if [ ! -f "wrangler.jsonc" ]; then
            echo "❌ Error: wrangler.jsonc not found. Make sure it was generated in the previous step."
            exit 1
          fi
          
          # Validate Cloudflare credentials are set
          if [ -z "${CLOUDFLARE_API_TOKEN:-}" ] || [ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]; then
            echo "❌ Error: CLOUDFLARE_API_TOKEN or CLOUDFLARE_ACCOUNT_ID is empty"
            exit 1
          fi
          
          # Create temporary JSON file with secrets
          SECRETS_FILE=$(mktemp)
          trap "rm -f '$SECRETS_FILE'" EXIT
          
          # Validate file was created successfully
          if [ ! -f "$SECRETS_FILE" ]; then
            echo "❌ Error: Failed to create temporary secrets file"
            exit 1
          fi
          
          # Write JSON file with proper escaping using Node.js
          node -e "
            const fs = require('fs');
            const secrets = {
              TELEGRAM_BOT_TOKEN_SECRET: process.env.TELEGRAM_BOT_TOKEN_SECRET,
              ADMIN_CHAT_ID: process.env.ADMIN_CHAT_ID
            };
            fs.writeFileSync('$SECRETS_FILE', JSON.stringify(secrets, null, 2));
          "
          
          # Verify JSON file is valid and not empty
          if [ ! -s "$SECRETS_FILE" ]; then
            echo "❌ Error: Secrets file is empty"
            exit 1
          fi
          
          # Verify JSON is valid
          if ! node -e "require('fs').readFileSync('$SECRETS_FILE', 'utf8'); JSON.parse(require('fs').readFileSync('$SECRETS_FILE', 'utf8'));" > /dev/null 2>&1; then
            echo "❌ Error: Secrets file contains invalid JSON"
            exit 1
          fi
          
          # Upload secrets using wrangler secret bulk
          # wrangler reads CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID from env
          echo "Setting Cloudflare secrets..."
          echo "Worker name from wrangler.jsonc:"
          node -e "try { const config = JSON.parse(require('fs').readFileSync('wrangler.jsonc', 'utf8').replace(/\/\/.*/g, '')); console.log(config.name || 'Not found'); } catch(e) { console.log('Warning: Could not find worker name in wrangler.jsonc'); }" || echo "Warning: Could not find worker name in wrangler.jsonc"
          
          # Use filename directly instead of stdin redirection for better compatibility
          # With set -e, the script will exit if this command fails
          npx wrangler secret bulk "$SECRETS_FILE"
          
          echo "✓ Secrets uploaded successfully"

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          workingDirectory: .
        continue-on-error: false

      - name: Set Telegram Webhook
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN_SECRET: ${{ secrets.TELEGRAM_BOT_TOKEN_SECRET }}
          WEBHOOK_URL: ${{ secrets.WORKER_URL }}
        run: |
          set -euo pipefail
          
          # Set webhook after deployment
          # Note: This is idempotent - safe to run on every deployment
          if [ -z "${TELEGRAM_BOT_TOKEN_SECRET:-}" ]; then
            echo "⚠️  Warning: TELEGRAM_BOT_TOKEN_SECRET not set, skipping webhook setup"
            exit 0
          fi
          
          if [ -z "${WEBHOOK_URL:-}" ]; then
            echo "⚠️  Warning: WORKER_URL secret not set, skipping webhook setup"
            exit 0
          fi
          
          node scripts/setup-telegram-webhook.js "${WEBHOOK_URL}"
          
          echo "✓ Telegram webhook configured successfully"
